---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeroMedia from '../../components/HeroMedia.astro';
import { getEntityDetails, type EntityDetail } from '../../data/entityDetails';
import type { VisualAsset } from '../../data/assets';
import { getRelatedPressCount, getRelatedPressItems, isExternalUrl, type PressItem } from '../../data/press';

export const prerender = true;

export async function getStaticPaths() {
  const details = getEntityDetails();
  return details.map((detail) => ({
    params: { slug: detail.slug },
    props: { detail },
  }));
}

const { detail } = Astro.props as { detail: EntityDetail };
const pageTitle = `${detail.name} — Portfolio Detail | Listwin Ventures`;
const pageDescription =
  detail.summary && detail.summary.trim().length
    ? detail.summary
    : `${detail.name} portfolio overview with Listwin Ventures.`;
const categoryLabels: Record<string, string> = {
  board: 'Board',
  investment: 'Investment',
  philanthropy: 'Philanthropy',
  hero: 'Spotlight',
};
const externalUrlLabel = detail.externalUrl ? detail.externalUrl.replace(/\/$/, '') : null;
const pressReleaseUrl =
  detail.slug === 'carbon-robotics'
    ? 'https://www.businesswire.com/news/home/20250602427241/en/Carbon-Robotics-Adds-Lead-Independent-Director-to-Board'
    : null;
const isCarbonRobotics = detail.slug === 'carbon-robotics';
const carbonFieldAsset: VisualAsset | null = isCarbonRobotics
  ? {
      id: 'carbon-robotics-laserweeder',
      name: 'Carbon Robotics LaserWeeder G2',
      path: 'https://res.cloudinary.com/dhqpqfw6w/image/upload/v1762633738/LaserWeeder-G2-600-Sunset_qghpi1.webp',
      alt: 'Carbon Robotics LaserWeeder G2 operating at sunset in a field',
    }
  : null;
const carbonVideos = isCarbonRobotics
  ? [
      'https://res.cloudinary.com/dhqpqfw6w/video/upload/v1762635443/CR_video_1_ui2n13.mp4',
      'https://res.cloudinary.com/dhqpqfw6w/video/upload/v1762635466/CR_video_1-1_ncwtrz.mp4',
    ]
  : [];
const galleryAssets = [carbonFieldAsset].filter(Boolean) as VisualAsset[];
const hideHeroMedia = ['sequoia', 'hwvp', 'telesoft'].includes(detail.slug);
const hideCategoryLabel = detail.slug === 'sequoia';
const isExternalCoveragePage = ['canary-foundation', 'stanford'].includes(detail.slug);
const expandRelatedPress = isExternalCoveragePage || detail.slug === 'openwave';
const relatedPressCount = getRelatedPressCount(detail.slug);
const relatedPress = getRelatedPressItems(detail.slug, expandRelatedPress ? 20 : 4);
const relatedReadingTitle = isExternalCoveragePage ? 'External coverage' : 'Related reading';
const formatPublished = (item: PressItem) => {
  if (item.isEvergreen) return 'Evergreen';
  if (item.publishedLabel) return item.publishedLabel;
  if (item.publishedIso) {
    const date = new Date(item.publishedIso);
    // Use UTC for date-only strings (YYYY-MM-DD) to avoid local timezone shifting the day.
    return new Intl.DateTimeFormat('en-US', {
      timeZone: 'UTC',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    }).format(date);
  }
  return '';
};
const carbonNews = isCarbonRobotics
  ? {
      title: 'Carbon Robotics Raises $20M, Teases New “AI Robot” for Farms',
      summary:
        'Fresh capital from a Giant Ventures–led Series D-2 extension brings total funding to $177M as Carbon Robotics prepares an AI-powered field robot that goes beyond weeding.',
      details: [
        'New product: an unrevealed AI robot slated to debut in ~9 months, leveraging the same computer vision + machine learning platform used in the LaserWeeder family.',
        'Existing lineup: LaserWeeder G2 for precision weed destruction and the Autonomous Tractor Kit (ATK) retrofit that turns conventional tractors autonomous.',
        'CEO Paul Mikesell (Isilon Systems co-founder) says the proprietary targeting system keeps high-powered lasers locked on weeds—something competitors underestimate.',
        'Operations span ~260 employees with manufacturing in Richland, WA and the Netherlands; equipment already runs in 14 countries with fast revenue growth.',
        'Technology edge: a shared “large plant model” aggregates data from every farm so each deployed unit benefits from global updates.',
        'Funding: $20M Series D-2 from UK-based Giant Ventures pushes lifetime financing to $177M, fueling expansion toward a broader AI robotics platform.',
      ],
      kicker: 'Latest News',
    }
  : null;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="space-y-8 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
    <div class="space-y-6 text-center">
      {!hideCategoryLabel && (
        <div class="flex flex-wrap justify-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-ink/50">
          <span class="rounded-full border border-ink/10 px-3 py-1 text-ink/70">
            {categoryLabels[detail.categories[0]] ?? detail.categories[0]}
          </span>
        </div>
      )}
      {!hideHeroMedia && (
        <div class="mx-auto flex max-w-md flex-col items-center space-y-4">
          <HeroMedia asset={detail.asset} linkHref={null} showCaption={false} />
        </div>
      )}
      {isCarbonRobotics && carbonVideos[0] && (
        <div class="mx-auto w-full max-w-5xl">
          <video
            class="w-full rounded-[40px] border border-ink/10 shadow-panel"
            src={carbonVideos[0]}
            autoplay
            muted
            loop
            playsinline
            controls
          />
        </div>
      )}
      <div class="space-y-2">
        <h1 class="font-display text-3xl font-semibold text-ink sm:text-4xl">{detail.name}</h1>
        <p class="text-base text-ink/70">{pageDescription}</p>
      </div>
      {(detail.externalUrl || pressReleaseUrl) && (
        <div class="flex flex-wrap justify-center gap-3">
          {detail.externalUrl && (
            <a class="btn btn-ink" href={detail.externalUrl} target="_blank" rel="noopener noreferrer">
              Visit official site
            </a>
          )}
          {pressReleaseUrl && (
            <a class="btn btn-ink" href={pressReleaseUrl} target="_blank" rel="noopener noreferrer">
              Read press release
            </a>
          )}
        </div>
      )}
    </div>

  </section>

  {detail.highlights.length > 0 && (
    <section class="space-y-6 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
      <h2 class="text-2xl font-semibold text-ink">Highlights</h2>
      <ul class="space-y-3 text-sm text-ink/75">
        {detail.highlights.map((highlight) => (
          <li key={highlight} class="rounded-[24px] border border-ink/10 bg-white/90 px-4 py-3 shadow">
            {highlight}
          </li>
        ))}
      </ul>
    </section>
  )}

  {carbonNews && (
    <section class="space-y-6 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
      <div class="space-y-3">
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-ink/50">{carbonNews.kicker}</p>
        <h2 class="text-2xl font-semibold text-ink">{carbonNews.title}</h2>
        <p class="text-ink/70">{carbonNews.summary}</p>
      </div>
      <ul class="space-y-3 text-sm text-ink/75">
        {carbonNews.details.map((detail) => (
          <li key={detail} class="rounded-[24px] border border-ink/10 bg-white/90 px-4 py-3 shadow">
            {detail}
          </li>
        ))}
      </ul>
    </section>
  )}

  {relatedPress.length > 0 && (
    <section class="space-y-6 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-[0.4em] text-ink/50">References</p>
          <h2 class="text-2xl font-semibold text-ink">{relatedReadingTitle}</h2>
          {!expandRelatedPress && relatedPressCount > relatedPress.length && (
            <p class="text-sm text-ink/60">
              Showing {relatedPress.length} of {relatedPressCount}.
            </p>
          )}
        </div>
        <a class="text-sm font-semibold text-brand transition hover:text-brand-soft" href="/press">
          View all press →
        </a>
      </div>
      <div class="grid gap-5 md:grid-cols-2">
        {relatedPress.map((item) => {
          const external = isExternalUrl(item.url);
          const published = formatPublished(item);
          return (
            <article key={item.id} class="space-y-3 rounded-[30px] border border-ink/10 bg-white/90 p-5 shadow">
              <p class="text-xs font-semibold uppercase tracking-[0.35em] text-ink/50">
                {item.publisher}
                {published ? ` • ${published}` : ''}
              </p>
              <div class="space-y-1">
                <h3 class="text-xl font-semibold text-ink">{item.title}</h3>
                <p class="text-sm text-ink/70">{item.summary}</p>
              </div>
              <div class="pt-1">
                <a
                  class="btn btn-ink px-4 py-2"
                  href={item.url}
                  target={external ? '_blank' : undefined}
                  rel={external ? 'noopener noreferrer' : undefined}
                >
                  Read
                </a>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  )}

  {galleryAssets.length > 0 && (
    <section class="space-y-4 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
      <h2 class="text-2xl font-semibold text-ink">Media gallery</h2>
      <div class="grid gap-6 md:grid-cols-2">
	        {galleryAssets.map((asset) => (
	          <figure key={asset.id} class="space-y-3">
	            <img
	              src={asset.path}
	              alt={asset.alt}
	              width="1600"
	              height="900"
	              loading="lazy"
	              class="w-full rounded-[32px] border border-ink/10"
	            />
	            <figcaption class="text-sm text-ink/60">{asset.name}</figcaption>
	          </figure>
	        ))}
      </div>
    </section>
  )}

  {carbonVideos.length > 0 && (
    <section class="space-y-4 rounded-apple bg-white/95 p-6 shadow-panel ring-1 ring-white/60 sm:p-10">
      <h2 class="text-2xl font-semibold text-ink">Field footage</h2>
      <div class="grid gap-6 md:grid-cols-2">
        {carbonVideos.map((src, index) => (
          <video
            key={src}
            class="w-full rounded-[32px] border border-ink/10"
            src={src}
            controls
            playsinline
            aria-label={`Carbon Robotics video ${index + 1}`}
          />
        ))}
      </div>
    </section>
  )}
</BaseLayout>
