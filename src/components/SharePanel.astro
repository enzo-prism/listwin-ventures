---
import { Icon } from 'astro-icon/components';

const {
  pageUrl,
  pageTitle = 'Listwin Ventures',
}: {
  pageUrl: string;
  pageTitle?: string;
} = Astro.props;

const encode = (value: string) => encodeURIComponent(value);

const socialLinks = [
  {
    network: 'x',
    label: 'X',
    icon: 'tabler:brand-twitter',
    href: `https://twitter.com/intent/tweet?url=${encode(pageUrl)}&text=${encode(pageTitle)}`,
  },
  {
    network: 'linkedin',
    label: 'LinkedIn',
    icon: 'tabler:brand-linkedin',
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${encode(pageUrl)}`,
  },
  {
    network: 'facebook',
    label: 'Facebook',
    icon: 'tabler:brand-facebook',
    href: `https://www.facebook.com/sharer/sharer.php?u=${encode(pageUrl)}`,
  },
];
---

<section class="rounded-apple border border-white/80 bg-white/95 p-4 shadow-panel ring-1 ring-white/60 sm:p-5">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-ink/55">Share this page</p>
    <div class="flex flex-wrap gap-2">
      {socialLinks.map((link) => (
        <a
          class="btn btn-ink px-3 py-2 text-xs"
          href={link.href}
          target="_blank"
          rel="noopener noreferrer"
          data-share-network={link.network}
          data-share-url={pageUrl}
          data-share-title={pageTitle}
          aria-label={`Share on ${link.label}`}
          title={`Share on ${link.label}`}
        >
          <Icon name={link.icon} width="14" height="14" />
          <span>{link.label}</span>
        </a>
      ))}
      <button
        type="button"
        class="btn btn-ink px-3 py-2 text-xs"
        data-share-copy
        data-share-url={pageUrl}
        data-default-label="Copy link"
        aria-label="Copy page link"
      >
        <Icon name="tabler:link" width="14" height="14" />
        <span data-copy-label>Copy link</span>
      </button>
    </div>
  </div>
</section>

<script is:inline>
  {(() => {
    const encode = (value) => encodeURIComponent(value);
    const buildShareHref = (network, url, title) => {
      if (network === 'x') {
        return `https://twitter.com/intent/tweet?url=${encode(url)}&text=${encode(title)}`;
      }
      if (network === 'linkedin') {
        return `https://www.linkedin.com/sharing/share-offsite/?url=${encode(url)}`;
      }
      if (network === 'facebook') {
        return `https://www.facebook.com/sharer/sharer.php?u=${encode(url)}`;
      }
      return url;
    };
    const runtimeUrl = (fallbackUrl) => window.location?.href || fallbackUrl;

    const shareLinks = Array.from(document.querySelectorAll('[data-share-network]'));
    shareLinks.forEach((link) => {
      const network = link.dataset.shareNetwork;
      const fallbackUrl = link.dataset.shareUrl || '';
      const title = link.dataset.shareTitle || document.title || 'Listwin Ventures';
      if (!network) return;
      const targetUrl = runtimeUrl(fallbackUrl);
      if (!targetUrl) return;
      link.setAttribute('href', buildShareHref(network, targetUrl, title));
    });

    const setLabel = (button, text) => {
      const label = button.querySelector('[data-copy-label]');
      if (label) label.textContent = text;
    };
    const copyWithFallback = async (url) => {
      if (navigator.clipboard?.writeText) {
        try {
          await navigator.clipboard.writeText(url);
          return true;
        } catch {
          // Fall through to legacy copy method.
        }
      }

      try {
        const input = document.createElement('textarea');
        input.value = url;
        input.setAttribute('readonly', '');
        input.style.position = 'fixed';
        input.style.top = '0';
        input.style.left = '0';
        input.style.opacity = '0';
        document.body.appendChild(input);
        input.focus();
        input.select();
        input.setSelectionRange(0, input.value.length);
        const copied = document.execCommand('copy');
        input.remove();
        return copied;
      } catch {
        return false;
      }
    };

    const copyButtons = Array.from(document.querySelectorAll('[data-share-copy]'));
    if (!copyButtons.length) return;

    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const url = runtimeUrl(button.dataset.shareUrl || '');
        if (!url) return;

        const defaultLabel = button.dataset.defaultLabel ?? 'Copy link';
        const copied = await copyWithFallback(url);

        if (copied) {
          setLabel(button, 'Copied');
        } else {
          setLabel(button, 'Copy failed');
        }

        window.setTimeout(() => setLabel(button, defaultLabel), 1800);
      });
    });
  })()}
</script>
