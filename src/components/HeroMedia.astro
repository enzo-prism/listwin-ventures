---
import type { VisualAsset } from '../data/assets';

export interface Props {
  asset: VisualAsset;
  rounded?: boolean;
  shadow?: boolean;
  className?: string;
  linkHref?: string | null;
  showCaption?: boolean;
  /**
   * Defaults to "lazy". Use "eager" for above-the-fold/LCP images.
   */
  loading?: 'lazy' | 'eager';
  /**
   * Optional hint for above-the-fold images.
   */
  fetchpriority?: 'high' | 'low' | 'auto';
}

const {
  asset,
  rounded = true,
  shadow = true,
  className = '',
  linkHref = undefined,
  showCaption = true,
  loading = 'lazy',
  fetchpriority = undefined,
} = Astro.props;

const resolvedLink = linkHref === null ? undefined : linkHref ?? asset.href;
const isExternal = resolvedLink ? !linkHref && !!asset.href : false;
const usesDarkFrame = asset.id === 'carbon-robotics';
const figureToneClass = usesDarkFrame ? 'bg-foreground text-background ring-border/20' : 'bg-card/95 text-foreground ring-border/70';
	const captionToneClass = usesDarkFrame ? 'text-background/60' : 'text-muted-foreground';
	const isLogoAsset = /\b(logo|lockup|crest)\b/i.test(asset.alt);
	const showMediaCaption = showCaption && !isLogoAsset;

	const inferImageDimensionsFromPath = (
	  path: string,
	  fallback: { width: number; height: number },
	): { width: number; height: number } => {
	  const match = path.match(/-(\d+)x(\d+)\.(?:png|jpe?g|webp)(?:\?|$)/i);
	  if (match) {
	    return { width: Number(match[1]), height: Number(match[2]) };
	  }
	  return fallback;
	};

	const dimensions = inferImageDimensionsFromPath(
	  asset.path,
	  isLogoAsset ? { width: 320, height: 128 } : { width: 1200, height: 900 },
	);
---

<figure
  class={`w-full flex flex-col items-center gap-3 rounded-[var(--radius-xl)] p-4 text-center text-sm shadow-panel ring-1 ${figureToneClass} ${className}`}
>
  {resolvedLink ? (
    <a
      href={resolvedLink}
      target={isExternal ? '_blank' : undefined}
      rel={isExternal ? 'noopener noreferrer' : undefined}
      class={`${rounded ? 'overflow-hidden rounded-[28px]' : ''} block`}
    >
	      <img
	        src={asset.path}
	        alt={asset.alt}
	        width={dimensions.width}
	        height={dimensions.height}
	        loading={loading}
	        fetchpriority={fetchpriority}
	        class={`w-full object-contain ${shadow ? 'shadow-panel' : ''}`}
	      />
    </a>
  ) : (
	    <img
	      src={asset.path}
	      alt={asset.alt}
	      width={dimensions.width}
	      height={dimensions.height}
	      loading={loading}
	      fetchpriority={fetchpriority}
	      class={`w-full object-contain ${rounded ? 'rounded-[28px]' : ''} ${shadow ? 'shadow-panel' : ''}`}
	    />
  )}
  {showMediaCaption && (
    <figcaption class={`text-xs uppercase tracking-[0.25em] ${captionToneClass}`}>{asset.name}</figcaption>
  )}
</figure>
