---
import '../styles/global.css';
import SiteNavigation from '../components/SiteNavigation';
import SharePanel from '../components/SharePanel.astro';
import { investmentAssets } from '../data/assets';
import { getEntityDetails, getDetailPath } from '../data/entityDetails';

const {
  title = 'Listwin Ventures',
  description = 'Technology investing, leadership, and philanthropy from Don Listwin.',
} = Astro.props;

const siteUrl = 'https://listwinventures.com';
const pageUrl = Astro.url?.href ?? siteUrl;
const logoUrl =
  'https://res.cloudinary.com/dhqpqfw6w/image/upload/v1762622395/LV_logo-02-300x120_gobztf.webp';
const openGraphImage = `${siteUrl}/assets/uploads/OpenGraph.png`;

const structuredData = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'Organization',
      '@id': `${siteUrl}#organization`,
      name: 'Listwin Ventures',
      url: siteUrl,
      logo: {
        '@type': 'ImageObject',
        url: logoUrl,
      },
      description,
      sameAs: [],
      founder: {
        '@id': `${siteUrl}#person`,
      },
    },
    {
      '@type': 'Person',
      '@id': `${siteUrl}#person`,
      name: 'Don Listwin',
      url: siteUrl,
      jobTitle: 'Founder & Managing Partner',
      description: 'Technology investor, CEO, philanthropist, and longtime operator.',
      worksFor: {
        '@id': `${siteUrl}#organization`,
      },
    },
    {
      '@type': 'WebSite',
      '@id': `${siteUrl}#website`,
      url: siteUrl,
      name: 'Listwin Ventures',
      description,
      publisher: {
        '@id': `${siteUrl}#organization`,
      },
    },
  ],
};

const entityDetails = getEntityDetails();
const detailBySlug = new Map(entityDetails.map((detail) => [detail.slug, detail]));

const hiddenInvestmentNavSlugs = new Set(['carbon-robotics', 'cradle']);
const exitSlugs = ['openwave', 'genologics', 'joyent', 'isilon', 'plumgrid', 'teradici'];

const prettify = (name: string) => name.replace(/\s+(logo|crest|lockup)$/i, '');

const workHighlights = [
  {
    label: 'Carbon Robotics',
    description: 'AI-driven laser weeding and farm autonomy.',
    href: getDetailPath('carbon-robotics') ?? '/',
    icon: 'rocket',
  },
  {
    label: '4AG',
    description: 'Autonomous mushroom cultivation and harvesting robotics.',
    href: '/4ag',
    icon: 'sparkles',
  },
  {
    label: 'BelizeKids.org',
    description: 'STEM, clinics, and conservation programs across Belize.',
    href: '/belizekids',
    icon: 'community',
  },
];

const investmentSections = investmentAssets
  .map((group) => {
    const items = group.items
      .map((asset) => detailBySlug.get(asset.id))
      .filter((detail) => detail && !hiddenInvestmentNavSlugs.has(detail.slug))
      .map((detail) => ({
        label: prettify(detail.name),
        href: getDetailPath(detail.slug),
      }));

    return { label: group.label, items };
  })
  .filter((section) => section.items.length > 0);

const exitItems = exitSlugs
  .map((slug) => detailBySlug.get(slug))
  .filter(Boolean)
  .map((detail) => ({
    label: prettify(detail.name),
    href: getDetailPath(detail.slug),
  }));

if (exitItems.length) {
  investmentSections.push({ label: 'Exits', items: exitItems });
}

const communityLinks = [
  { slug: 'belizekids', icon: 'heart' },
  { slug: 'canary-foundation', icon: 'shield' },
  { slug: 'lucile', icon: 'hospital' },
  { slug: 'nih', icon: 'bank' },
  { slug: 'stanford', icon: 'school' },
  { slug: 'saskatchewan', icon: 'church' },
]
  .map(({ slug, icon }) => {
    const detail = detailBySlug.get(slug);
    return detail
      ? {
          label: prettify(detail.name),
          href: getDetailPath(detail.slug),
          icon,
        }
      : null;
  })
  .filter((item): item is { label: string; href: string; icon: string } => Boolean(item));

const storyLinks = [
  { label: "Oral History '18", href: '/oral-history', icon: 'about' },
  { label: "Caltech Interview '25", href: '/oral-history-caltech', icon: 'news' },
  { label: 'My Story', href: '/#my-story', icon: 'user' },
  { label: 'Press', href: '/press', icon: 'news' },
];

const navItems = [
  { label: 'Home', href: '/', icon: 'home' },
  {
    label: 'New',
    icon: 'sparkles',
    sections: [{ label: 'Current Focus', items: workHighlights }],
  },
  {
    label: 'Investments',
    icon: 'briefcase',
    sections: investmentSections,
  },
  {
    label: 'Community',
    icon: 'users',
    sections: [{ label: 'Projects & Partnerships', items: communityLinks }],
  },
  {
    label: 'About',
    icon: 'about',
    sections: [{ label: 'Story', items: storyLinks }],
  },
];

const rawPathname = Astro.url?.pathname ?? '/';
const pathname = rawPathname === '/' ? '/' : rawPathname.replace(/\/+$/, '');
const shareEnabledPaths = new Set([
  '/',
  '/oral-history',
  '/oral-history-caltech',
  '/press',
  '/4ag',
  '/belizekids',
  '/genologics',
  '/zevx-closes-20m-funding-round-appoints-don-listwin-as-ceo',
]);
const shareEnabledPrefixes = ['/company/', '/exploits/'];
const showSharePanel =
  shareEnabledPaths.has(pathname) || shareEnabledPrefixes.some((prefix) => pathname.startsWith(prefix));
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:site_name" content="Listwin Ventures" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:image" content={openGraphImage} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={openGraphImage} />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/uploads/Favicon%201.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/uploads/Favicon%202.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/assets/uploads/Favicon%203.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/uploads/Favicon%204.png" />
    <link rel="apple-touch-icon" href="/assets/uploads/Favicon%204.png" />
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin />
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5R6NTCMFK3"></script>
    <script is:inline>
      {(() => {
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'G-5R6NTCMFK3');
      })()}
    </script>
    <script is:inline>
      {(function (h, o, t, j, a, r) {
        h.hj =
          h.hj ||
          function () {
            (h.hj.q = h.hj.q || []).push(arguments);
          };
        h._hjSettings = { hjid: 6585931, hjsv: 6 };
        a = o.getElementsByTagName('head')[0];
        r = o.createElement('script');
        r.async = 1;
        r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
        a.appendChild(r);
      })(window, document, 'https://static.hotjar.com/c/hotjar-', '.js?sv=')}
    </script>
  </head>
  <body>
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded-full focus:bg-card focus:px-4 focus:py-2 focus:text-sm focus:font-semibold focus:text-foreground"
    >
      Skip to content
    </a>

    <div class="flex min-h-screen flex-col">
      <header class="sticky top-0 z-40 border-b border-border/70 bg-background/85 backdrop-blur">
        <div class="mx-auto flex w-full max-w-6xl items-center justify-between gap-4 px-4 py-3 sm:px-6 lg:px-8">
          <a href="/" class="group flex items-center gap-3 text-xl font-semibold tracking-tight text-foreground no-underline">
            <img
              src={logoUrl}
              alt="Listwin Ventures"
              width="300"
              height="120"
              class="h-10 w-auto transition-opacity duration-200 group-hover:opacity-80"
              loading="eager"
              fetchpriority="high"
            />
            <span class="sr-only">Listwin Ventures</span>
          </a>
          <SiteNavigation client:load items={navItems} contactHref="/contact" />
        </div>
      </header>

      <main id="main-content" class="flex-1" tabindex="-1">
        <div class="mx-auto w-full max-w-6xl space-y-10 px-4 py-10 sm:px-6 lg:px-8">
          {showSharePanel && <SharePanel pageUrl={pageUrl} pageTitle={title} />}
          <slot />
        </div>
      </main>

      <footer class="border-t border-border/70 bg-card/80">
        <div class="mx-auto flex max-w-6xl flex-col gap-4 px-4 py-6 text-sm text-muted-foreground sm:flex-row sm:items-center sm:justify-between sm:px-6 lg:px-8">
          <div class="flex items-center gap-3">
            <img
              src={logoUrl}
              alt="Listwin Ventures"
              width="300"
              height="120"
              class="h-8 w-auto"
              loading="lazy"
            />
            <span>&copy; {new Date().getFullYear()} Listwin Ventures. All rights reserved.</span>
          </div>
          <div class="flex flex-wrap gap-5">
            <a href="/privacy-policy" class="text-muted-foreground no-underline hover:text-foreground">Privacy</a>
            <a href="/cookie-policy" class="text-muted-foreground no-underline hover:text-foreground">Cookies</a>
          </div>
        </div>
      </footer>
    </div>
    <script is:inline>
      {(() => {
        const typingEl = document.getElementById('hero-typing');
        const typingPhrases = ['Technology investor', 'CEO', 'Philanthropist'];

        if (!typingEl || !typingPhrases.length) return;

        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
          typingEl.textContent = typingPhrases[0];
          return;
        }

        const typingWrapper = typingEl.closest('.typing-line');
        if (typingWrapper) {
          const typingComputed = window.getComputedStyle(typingEl);
          const wrapperComputed = window.getComputedStyle(typingWrapper);
          const cursorEl = typingWrapper.querySelector('[aria-hidden="true"]');
          const measure = document.createElement('span');

          measure.style.position = 'absolute';
          measure.style.visibility = 'hidden';
          measure.style.pointerEvents = 'none';
          measure.style.whiteSpace = 'nowrap';
          measure.style.font = typingComputed.font;
          measure.style.letterSpacing = typingComputed.letterSpacing;
          measure.style.textTransform = typingComputed.textTransform;
          measure.style.textRendering = typingComputed.textRendering;

          document.body.appendChild(measure);
          let maxWidth = 0;
          typingPhrases.forEach((phrase) => {
            measure.textContent = phrase;
            maxWidth = Math.max(maxWidth, measure.getBoundingClientRect().width);
          });
          measure.remove();

          const gapWidth = Number.parseFloat(wrapperComputed.columnGap || wrapperComputed.gap || '0') || 0;
          const cursorWidth = cursorEl ? cursorEl.getBoundingClientRect().width : 2;
          const safetyPadding = 8;
          const totalWidth = Math.ceil(maxWidth + gapWidth + cursorWidth + safetyPadding);
          typingWrapper.style.setProperty('--typing-width', `${totalWidth}px`);
        }

        let phraseIndex = 0;
        let charIndex = 1;
        let deleting = false;

        const typeSpeed = 90;
        const eraseSpeed = 60;
        const holdTime = 1200;

        const typeLoop = () => {
          const currentPhrase = typingPhrases[phraseIndex];
          if (!deleting) {
            typingEl.textContent = currentPhrase.substring(0, charIndex);
            charIndex += 1;

            if (charIndex > currentPhrase.length) {
              setTimeout(() => {
                deleting = true;
                charIndex = currentPhrase.length;
                typeLoop();
              }, holdTime);
              return;
            }
          } else {
            typingEl.textContent = currentPhrase.substring(0, Math.max(1, charIndex));
            charIndex -= 1;

            if (charIndex <= 1) {
              deleting = false;
              phraseIndex = (phraseIndex + 1) % typingPhrases.length;
              charIndex = 1;
              setTimeout(typeLoop, typeSpeed);
              return;
            }
          }

          setTimeout(typeLoop, deleting ? eraseSpeed : typeSpeed);
        };

        typeLoop();
      })()}
    </script>
  </body>
</html>
